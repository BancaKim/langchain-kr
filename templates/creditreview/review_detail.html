{% include 'header.html' %}

{% block head %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const streamContent = document.getElementById('streamContent');

        async function fetchContent() {
            // SweetAlert2를 사용하여 5초 동안 로딩 화면 표시
            await Swal.fire({
                title: 'AI 심사보고서 생성중',
                html: '잠시만 기다려주세요...',
                timer: 3000,
                timerProgressBar: true,
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/credit/stream-content/{{reportContent.rcept_no}}');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    streamContent.innerHTML += chunk;
                }
            } catch (error) {
                console.error('Error:', error);
                streamContent.textContent = '내용을 불러오는 중 오류가 발생했습니다.';
                // 오류 발생 시 alert 표시
                Swal.fire({
                    icon: 'error',
                    title: '오류 발생',
                    text: '심사보고서를 불러오는 중 문제가 발생했습니다.'
                });
            }
        }

        fetchContent();
    });
</script>
<style>
    #streamContent {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .equal-height {
        display: flex;
        flex-wrap: wrap;
    }

    /*
    .equal-height>div {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
*/
    .container {
        max-width: 80%;
    }

    .min-h-600 {
        min-height: 600px;
    }


    /* 채팅창 스타일 */
    /* 채팅창 스타일 */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .chat-message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
    }

    .bot {
        background-color: #f0f0f0;
        border: 1px solid #d0d0d0;
        align-self: flex-start;
    }

    .user {
        background-color: #e7f3fe;
        border: 1px solid #c0d9f0;
        align-self: flex-end;
        margin-left: auto;
    }

    .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        flex-wrap: wrap;
        gap: 10px;
    }

    #userInput {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-width: 0;
        /* 이 설정으로 인해 Flexbox에서 줄어들어야 할 때 정상적으로 작동합니다. */
    }

    #sendButton {
        padding: 10px 20px;
        background-color: #7F56D9;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        flex-shrink: 0;
        /* 버튼이 줄어들지 않도록 고정 크기를 유지합니다. */
    }

    @media (max-width: 850px) {
        .hide-on-small {
            display: none;
        }

        .height30 {
            height: 25vh;
        }

        .hidden-below-850 {
            display: none;
        }

        .show-below-850 {
            display: block;
        }

        .container {
            max-width: 100%;
        }

        .chat-input {
            flex-direction: column;
        }
    
        #sendButton {
            width: 100%;
            padding: 10px;
            margin-left: 0;
        }
    }
</style>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/font.css">
{% endblock %}



{% block content %}
<div class="w-full"
    style="background-image: url('/static/images/home7.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; min-height: 40vh;">
    <div class="w-full max-w-screen-xl p-8 mx-auto height30">

        <span class="block mb-2 text-xl text-left ">
            <a href="/" class="mr-2 text-white ">홈 &nbsp; |</a>
            <a href="/credit/creditReview" class="ml-2 text-white">AI심사보고서 &nbsp; |</a>
            <span class="text-white"> &nbsp; 종합의견</span>
        </span>
        <br><br>
        <div class="hidden-below-850">
            <br>
        </div>

        <div class="mb-4 text-center">
            <h1 class="text-3xl font-bold text-white lg:text-5xl">심사보고서 종합 의견</h1>
        </div>
        <br>
        <div class="hidden-below-850">
            <br><br>
        </div>
    </div>
</div>
<br>

<div class="container px-6 mx-auto my-8">

    <div class="flex items-center justify-between mb-5">
        <h2 class="text-4xl font-bold">{{ company_info.corp_name }}</h2>


        <div class="p-0 text-xl hide-on-small">업체의 자세한 정보가 궁금하다면?
            <a href="/baro_companyInfo?jurir_no={{ company_info.jurir_no }}"
                class="px-2 py-2 text-purple-700 hover:underline">
                BizInfo
            </a>
        </div>
    </div>

    <div class="show-below-850">
        <br>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3 equal-height">
        <!-- 기업정보 영역 -->
        <div class="space-y-6 lg:block lg:col-span-1 hidden-below-850">
            <div class="flex flex-col space-y-6">
                <div class="flex-1 bg-white rounded-lg shadow-lg">
                    <div class="p-3 bg-gray-100 border-b border-gray-300 rounded-t-lg">
                        <h2 class="text-xl font-semibold text-gray-800">기본 정보</h2>
                    </div>
                    <div class="p-6">
                        {% if company_info %}
                        <br>
                        <ul class="pl-5 space-y-2 list-disc">
                            <li>
                                <p class="mb-4 text-lg font-semibold">기업명: {{ company_info.corp_name }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">대표: {{ company_info.ceo_nm }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">법인구분:
                                    {% if company_info.corp_cls == 'Y' %}
                                    유가 (Y)
                                    {% elif company_info.corp_cls == 'K' %}
                                    코스닥 (K)
                                    {% elif company_info.corp_cls == 'N' %}
                                    코넥스 (N)
                                    {% elif company_info.corp_cls == 'E' %}
                                    기타 (E)
                                    {% else %}
                                    {{ company_info.corp_cls }}
                                    {% endif %}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">주소: {{ company_info.adres }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">홈페이지: {{ company_info.hm_url }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">H.P: {{ company_info.phn_no }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">Fax: {{ company_info.fax_no }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">산업코드: {{ company_info.induty_code }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">법인번호: {{ company_info.jurir_no }}</p>
                            </li>
                            <li>
                                <p class="mb-4 text-lg font-semibold">설립일: {{ company_info.est_dt }}</p>
                            </li>
                            <li>
                                <p class="text-lg font-semibold">최근 섭외내역</p>
                                <div class="flex-grow p-6 overflow-y-auto sticky-notes-container">
                                    {% if posts %}
                                    {% for post in posts %}
                                    <div class="flex space-x-4 sticky-note-row">
                                        <div
                                            class="relative flex-1 p-4 mb-4 rounded-lg shadow-md sticky-note bg-purple-50">
                                            <p class="sticky-note-content">{{ post.content }}</p>
                                            <br><br>
                                            <div class="absolute text-sm sticky-note-info bottom-4 left-4">
                                                <span>섭외유형: {{ post.contact_type }}</span><br>
                                                <span>섭외방법: {{ post.contact_method }}</span>
                                            </div>

                                            <div class="absolute text-sm text-right sticky-note-info bottom-4 right-4">
                                                <span>{{ post.username }}</span><br>
                                                <span>{{ post.created_at.strftime('%Y-%m-%d') }}</span>
                                            </div>
                                        </div>
                                        <br><br>
                                    </div>
                                    {% endfor %}
                                    <br>
                                    {% else %}
                                    <p class="text-gray-600">등록된 섭외 내역이 없습니다.</p>
                                    {% endif %}
                                </div>
                            </li>

                        </ul>
                        {% else %}
                        <p class="text-gray-600">해당 기업은 금융감독원(Dart API)에서 정보를 제공받을 수 없습니다.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>


        <div id="streamContent" class="flex flex-col col-span-1 lg:col-span-2 lg:col-start-2">
            <!-- 스트리밍된 콘텐츠가 이곳에 삽입됩니다 -->
        </div>
    </div>




    <br>
    <!-- 챗봇 시작-->
    <div class="flex-1 bg-white rounded-lg shadow-lg">
        <div class="p-3 bg-gray-100 border-b border-gray-300 rounded-t-lg">
            <h2 class="text-xl font-semibold text-center text-gray-800">AI 챗봇</h2>
        </div>
        <div class="chat-container">
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message bot">
                    안녕하세요!<br>
                    AI 기업금융 전문가 Spoon 입니다.<br>
                    {{company_info.corp_name}}에 대해 궁금한 점이 있으신가요?
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="userInput" placeholder="메시지를 입력하세요...">
                <button id="sendButton">전송</button>
            </div>
        </div>
    </div>
    <!-- 챗봇 끝 -->

</div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        function addMessage(message, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(isUser ? 'user' : 'bot');
            if (!isUser) {
                message = message.replace(/\(출처: Document\)/g, "(출처: AI심사보고서)");
            }


            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (message) {
                addMessage(message, true);
                userInput.value = '';

                // Show loading alert
                Swal.fire({
                    title: 'AI 응답이 생성중입니다.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Send message to server and get response
                fetch(`/credit/chatMessage?corp_code={{company_info.corp_code}}&user_input=${encodeURIComponent(message)}`)
                    .then(response => response.json())
                    .then(data => {
                        Swal.close();
                        addMessage(data.answer, false);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.close();
                        addMessage('죄송합니다. 오류가 발생했습니다.', false);
                    });
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>

<br><br><br><br><br><br><br><br>

{% endblock %}

{% include 'footer.html' %}