{% extends "base.html" %}

{% block title %}AI심사보고서{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const streamContent = document.getElementById('streamContent');
        
        async function fetchContent() {
            // SweetAlert2를 사용하여 5초 동안 로딩 화면 표시
            await Swal.fire({
                title: 'AI 심사보고서 생성중',
                html: '잠시만 기다려주세요...',
                timer: 5000,
                timerProgressBar: true,
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/credit/stream-content/{{reportContent.rcept_no}}');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    streamContent.innerHTML += chunk;
                }
            } catch (error) {
                console.error('Error:', error);
                streamContent.textContent = '내용을 불러오는 중 오류가 발생했습니다.';
                // 오류 발생 시 alert 표시
                Swal.fire({
                    icon: 'error',
                    title: '오류 발생',
                    text: '심사보고서를 불러오는 중 문제가 발생했습니다.'
                });
            }
        }

        fetchContent();
    });
    </script>
    <style>
        #streamContent {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
    <link rel="stylesheet" href="/static/css/review_detail.css"> 
{% endblock %}

{% block content %}
<h1>AI심사보고서 > 보고서 보기</h1>

<h2>심사보고서</h2>

<p><strong>순서:</strong> {{reportContent.report_num}}</p>
<p><strong>회사코드:</strong> {{reportContent.corp_code}}</p>
<p><strong>회사명:</strong> {{reportContent.corp_name}}</p>
<p><strong>보고서명:</strong> {{reportContent.report_nm}}</p>
<p><strong>보고서번호:</strong> {{reportContent.rcept_no}}</p>

<h3>종합의견</h3>
<div id="streamContent"></div>

<div class="btn-group">
    <button onclick="history.back()">이전으로 가기</button>
</div>
{% endblock %}