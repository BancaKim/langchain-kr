<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <title>Prediction Results</title>
    <style>
        /* CSS 수정 부분 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        .bg-cover {
            width: 100%;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
        }

        th, td {
            padding: 8px;
            text-align: center; /* 중앙 정렬 */
            border: 1px solid black;
        }

        thead {
            background-color: #f1f1f1;
        }

        tbody tr:hover {
            background-color: #e1e1e1;
        }

        .summary {
            margin-bottom: 20px;
        }

        .bg-white {
            padding: 20px;
        }

        h1, h2 {
            text-align: center;
        }
    </style>
</head>

<body class="bg-gray-100">

    {% include 'header.html' %}

    <div class="container mx-auto p-8">

        <div class="bg-cover bg-center h-72 flex items-center justify-center text-center p-8 text-white"
            style="background-image: url('/static/images/admin3.jpg');">
            <div class="max-w-4xl w-full">
                <h1 class="text-5xl font-bold">바로등급 산출 결과</h1>
            </div>
        </div>
        <br> 

        <div class="container mx-auto p-4 bg-white shadow-lg rounded-lg mb-4">

            <div id="summary" class="summary mt-10">
                <h2 class="text-3xl font-semibold mb-4">분석 요약</h2>
                <p id="modelInfo" class="mb-2">
                    model id: {{ model_id }},
                    모델명: {{ model_info.model_name }}, 생성일: {{ model_info.creation_date }},
                    추정기 수: {{ model_info.n_estimators }}, 최대 피처: {{ model_info.max_features }}, 샘플 수: {{ model_info.n_samples }}
                </p>
                <p id="elapsedTime" class="mb-2">소요 시간: {{ elapsed_time }} 초</p>
                <p id="dataCount" class="mb-2">조회 건수: {{ count }} 건</p>
                <br>

                <button id="dbButton" onclick="uploadToDB()"
                class="px-6 py-3 bg-gray-800 text-white rounded hover:bg-gray-900">바로등급 DB 적재</button>

            </div>
        </div>

        <div class="container mx-auto p-4 bg-white shadow-lg rounded-lg">
            <h2 class="text-3xl font-semibold mt-10 mb-4">ML기반 바로등급 산출 내역</h2>
      
            <div class="table-container">
                <table id="resultsTable" class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6">법인번호</th>
                            <th class="py-3 px-6">법인명</th>
                            <th class="py-3 px-6">AAA</th>
                            <th class="py-3 px-6">AA+</th>
                            <th class="py-3 px-6">AA</th>
                            <th class="py-3 px-6">AA-</th>
                            <th class="py-3 px-6">A+</th>
                            <th class="py-3 px-6">A</th>
                            <th class="py-3 px-6">A-</th>
                            <th class="py-3 px-6">BBB+</th>
                            <th class="py-3 px-6">BBB</th>
                            <th class="py-3 px-6">BBB-</th>
                            <th class="py-3 px-6">BB+</th>
                            <th class="py-3 px-6">BB</th>
                            <th class="py-3 px-6">BB-</th>
                            <th class="py-3 px-6">B+</th>
                            <th class="py-3 px-6">B</th>
                            <th class="py-3 px-6">B-</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="text-gray-600 text-sm font-light">
                        {% for result in predictions %}
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 whitespace-nowrap">{{ result.jurir_no }}</td>
                            <td class="py-3 px-6">{{ result.corp_name }}</td>
                            {% for grade in ['AAA', 'AA+', 'AA', 'AA-', 'A+', 'A', 'A-', 'BBB+', 'BBB', 'BBB-', 'BB+',
                            'BB', 'BB-', 'B+', 'B', 'B-'] %}
                            {% if result.sorted_probabilities.get(grade, 0) > 0 %}
                            <td class="py-3 px-6">{{ result.sorted_probabilities.get(grade) }}</td>
                            {% else %}
                            <td class="py-3 px-6"></td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rows = document.querySelectorAll("#resultsBody tr");

            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("td")).slice(2); // Skip first two cells (법인번호, 법인명)
                const values = cells.map(cell => parseFloat(cell.textContent) || 0);

                // Find the indices of the top 3 values
                const top3Indices = values
                    .map((value, index) => [value, index])
                    .sort((a, b) => b[0] - a[0])
                    .slice(0, 3)
                    .map(item => item[1]);

                // Apply background colors to top 3 values
                top3Indices.forEach((index, i) => {
                    if (i === 0) {
                        cells[index].classList.add('bg-gray-400'); // Highest value
                    } else if (i === 1) {
                        cells[index].classList.add('bg-gray-300'); // Second highest value
                    } else if (i === 2) {
                        cells[index].classList.add('bg-gray-200'); // Third highest value
                    }
                });
            });
        });

    async function uploadToDB() {
        try {
            const response = await fetch('/insert_predictions/?model_id={{ model_id }}', {
                method: 'GET',
            });

            const result = await response.json();

            if (result.message) {
                alert(result.message); // 성공 메시지 표시
            } else if (result.error) {
                alert(result.error); // 에러 메시지 표시
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while uploading the predictions.');
        }
    }
    </script>
</body>

</html>
